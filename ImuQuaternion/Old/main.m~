%% Estabelecimento da Conexao Bluetooth
if exist('porta')
    fclose(porta);
end
clear ;close all;clc
disp('Conectando a Porta Serial...');
global porta
% porta = serial('/dev/ttyACM0','BaudRate',115200,'Terminator','CR');
porta = serial('/dev/ttyACM0','BaudRate',115200,'Terminator','CR');
fopen(porta);
disp('Conectado.');
Ts = 1/50;
Qn = 1e-5*eye(4);
Qn_v2 = 1e-5*eye(7);
Rn = 0.71e-3*eye(6); 
Rn(4,4) = 2;
Rn(5,5) = 2;
Rn(6,6) = 3;
% return

Q_bias = Ts^2/2;

Qn_euler = [0.01 0 0 0 0 0;
    0 0.01 0 0 0 0;
    0 0 0.01 0 0 0;
    0 0 0 Ts^2/2 0 0;
    0 0 0 0 Ts^2/2 0;
    0 0 0 0 0 Ts^2/2];

Rn_euler = 0.20*eye(3);

% sim('simula')
% return
q_k = [1 0 0 0];
%% APENAS PLOTA O QUATERNION DA PLACA
flushinput(porta);
while(1)
    
    while(porta.BytesAvailable==0)
    end
    
    x = fscanf(porta,'%f %f %f\n\r')
if(length(x) ~= 3)
    x = zeros(1,3);
end 

% m_inclination = deg2rad(19.2568); %graus (ADQUIRIDO ONLINE)
% a_measure = [-u(2) u(1) u(3)]' * 0.488e-3 * 9.80665; %m/s²
w_measure = [x(1) x(2) x(3)]';
% m_measure = [-u(8) u(7) u(9)]' * 0.1;  %uT

% a_measure = [u(1) u(2) u(3)]' * 0.488e-3 * 9.80665; %m/s²
% w_measure = [u(4) u(5) u(6)]' * 15.625e-3 * pi/180; %rad / s
% m_measure = [u(7) u(8) u(9)]' * 0.1  %uT


% m_field = norm(m_measure);
% g = [0 0 9.8]';
% mag_m  = m_field*cos(m_inclination);
% mag_n = m_field*sin(m_inclination);
% m = [mag_m 0 mag_n]';
% yin = a_measure;
% yin =[a_measure;m_measure];%

%x_k+1 = x_k + f(x_k)dt + G.udt

q_k1 = (q_k + (Ts/2)*quatmultiply(q_k,[0 w_measure']))';%Assume calibrado (bias constante) %-Ts/2 *quatmultiply(q_k,[0 bias]); 
x_est = q_k1;
%bias_k1 = bias' - Ts*[0.1 0 0;0 0.1 0;0 0 0.1]*bias' + Ts*bias_adj';

% y_q = quatmultiply(quatconj(q_k1'),[0 0 0 9.8]);%y = h(x)
% y_est = quatmultiply(y_q,q_k1')';
a_est = quatrotate(x_est',g')'; %nav2body

m_est = quatrotate(x_est',m')'; %nav2body

y_est = [a_est;m_est]; % 6x1

Jf = (Ts/2)*[2/Ts -w_measure(1) -w_measure(2) -w_measure(3);
      w_measure(1) 2/Ts w_measure(3) -w_measure(2);
      w_measure(2) -w_measure(3) 2/Ts w_measure(1)
      w_measure(3) w_measure(2) -w_measure(1) 2/Ts];
  
%  x_est = x;

Jh1 =2*9.8*[-x_est(3) x_est(4) -x_est(1) x_est(2);
    x_est(2) x_est(1) x_est(4) x_est(3);
    x_est(1) -x_est(2) -x_est(3) x_est(4)];

%REVISAR
% Jh2 = 2*[0 0 0 0;
%       (x(1)*mag_m-x(3)*mag_n) -x(2)*mag_m (-x(3)*mag_m-x(1)*mag_n) -x(4)*mag_m;
%       (x(4)*mag_m+x(2)*mag_n) (x(3)*mag_m+x(1)*mag_n) (x(2)*mag_m+x(4)*mag_n) (x(3)*mag_n+x(1)*mag_m);
%       (x(1)*mag_n+x(3)*mag_m) (-x(2)*mag_n+x(4)*mag_m) (-x(3)*mag_n+x(1)*mag_m) (x(4)*mag_n+x(2)*mag_m)];

Jh2 = 2*mag_m*[x_est(1) x_est(2) -x_est(3) -x_est(4);
    -x_est(4) x_est(3) x_est(2) -x_est(1);
    x_est(3) x_est(4) x_est(1) x_est(2)];
           
Jh2 = Jh2 + 2*mag_n*[-x_est(3) x_est(4) -x_est(1) x_est(2);
    x_est(2) x_est(1) x_est(4) x_est(3);
    x_est(1) -x_est(2) -x_est(3) x_est(4)];


%     Jh2 = zeros(4);
    
    Jh = [Jh1;Jh2];
    
    %PREDICT
    xhat = q_k1;
    Pk = Jf*Pk*Jf'+Qn; %P_k = Jf(xhar_k-1,u_k)P_k-1J'(xhat_k-1,u_k) + Q_k
    %CORRECT
    Kk = Pk*Jh'/(Jh*Pk*Jh'+Rn);
    sys = xhat + Kk*(yin-y_est);
    Pk = (eye(4) - Kk*Jh)*Pk;
    



end
    
    

% Pitch
